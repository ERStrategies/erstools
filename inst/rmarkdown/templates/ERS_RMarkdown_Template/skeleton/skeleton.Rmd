---
title: "Oct. 2024 Template Script"
author: "Zach Friedman"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3   # Customize the depth of the table of contents for HTML document
    toc_float:
      collapsed: true    # Start with the table of contents expanded
      smooth_scroll: true  # Enable smooth scrolling
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_dir = "knitted files", output_format = "all") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Part 0: Read Libraries and connect to Sharepoint

### 0.1 (OPTIONAL) Install the latest version of the erstools library!

**ACTION: If you aren't sure if you have the most up to date release of erstools, follow these instructions: https://app.tettra.co/teams/ersknowledge/pages/updating-erstools-functions-markdown-template**

### 0.2 Read All Libraries

**ACTION: Run the code and read the comments for different functions you will have access to**

```{r, warning = F, message = F}
#ERS-specific functions!!
library(erstools) #includes functions like ers_read_sharepoint, ers_write_sharepoint, ers_table, and ers_column_info

#load data
library(Microsoft365R) # Use Microsoft365R to connect to SharePoint and load files
library(readxl) # Functions for reading Excel files: read_excel
library(writexl) # Functions for writing Excel files: write_xlsx
library(openxlsx) # Functions for writing Excel files: write.xlsx

#manipulate data
library(tidyverse) # Includes ggplot2, dplyr, tidyr, readr, etc.
library(data.table) # fread(): load large CSVs quickly
library(janitor) # Functions for cleaning and examining data: clean_names() instantly formats all column names
library(safejoin) # Provides safer join operations for 1:many matching - safe_left_join()
library(stringr) # str_detect(): pattern matching using regular expressions (see regex101.com)

#format and display data
library(scales) # Functions for scaling and formatting axes in plots: comma(), percent()
library(gt) # Creates and formats tables in a publication-ready format: gt()
library(flextable) # Creates and formats tables in a publication-ready format: flextable()
library(extrafont) # Manages and uses custom fonts in plots - loadfonts(): Loads fonts available on the system

#share output with supervisor
library(rmarkdown) # needed to create knitted files in output folder
library(downloadthis) # create download buttons in your knitted file so that a supervisor can download data in Excel!
```

## Part 1: Bring in your data

### 1.0 Authenticate to sharepoint to be able to read in files

**ACTION: After running the code, you may need to look at your console code window below for instructions to log in. A window may open in your browser to ask you to log into Microsoft to confirm your identity**

**NOTE: If you ever have authentication issues, first run this in your console then try running the code chunk below again - AzureAuth::clean_token_directory()**

```{r}
#set sharepoint site URL for access to our org-wide files
orgfiles_site_url <- "https://erstrategies1.sharepoint.com/sites/orgfiles"
#access sharepoint site URL you may be prompted to sign in here
orgfiles_site <- get_sharepoint_site(site_url = orgfiles_site_url)
```

### 1.1 Set your folder path(s)

**ACTION: Change the raw_data_folder_path to the path to your data. The folder path must start with a folder that is below the "Client Work" level. For example, it should start with "District Partners", "Internal", "State Partners", etc.**

**NOTE: If you don't want to type the name of your folder path, you can copy it directly from Sharepoint: <https://app.tettra.co/teams/ersknowledge/pages/copying-a-folder-path-from-sharepoint-to-use-in-r>**

```{r}
raw_data_folder_path <- "District Partners/Columbus City/22-23 Financial Equity & Funding System Design/1. Data & Analysis - Secure/Raw Data for R"
```

### 1.2 See guidance on using the "ers_read_sharepoint" function

**ACTION: Run the code below to see documentation on our custom function!**

```{r, eval = interactive()}
?ers_read_sharepoint
```

### 1.3 Read in your data

**ACTION: Replace "raw_data" with the desired name of your data frame and replace "XXX.csv" with the file name. We suggest doing this for all instances of raw data by using the find and replace tool (Ctrl + F and then replace all instances of "raw_data" with the desired name.**

```{r}
raw_data <- ers_read_sharepoint(folder_path = raw_data_folder_path,
                   file_name_with_extension = "XXX.csv")
```

### 1.4 View your data

**ACTION: Replace "raw_data" with the same name of your data frame you used above, and run the code to inspect your data.**

```{r, eval = interactive()}
View(raw_data)
```

## Part 2: Validate Data

### 2.0 Check out the ers_column_info function as a starting place in your data validation (credits to Mauro!)

**ACTION: Run the code below to see documentation on our custom function!**

```{r, eval = interactive()}
?ers_column_info
```

### 2.1 Run ers_column_info on your data

**ACTION: Replace "raw_data" with the name of your data frame**

```{r}
ers_column_info(raw_data)
```

## Part 3: Process your data (more to come here later)

## Part 4: Analyze/view your data

### 4.0 Check out the ers_table function to make your tables nice using the gt package. (credits to Mauro!)

**ACTION: Run the code below to see documentation on our custom function!**

```{r, eval = interactive()}
?ers_table
```

### 4.1 Run ers_table on your data

**ACTION: Replace "example_analysis_table" with the name of processed analysis output you want to display nicely and XXX with the desired title of your table. NEVER RUN THIS FUNCTION ON MORE THAN 100 LINES OF DATA BECAUSE IT WILL BE VERY SLOW. THIS IS NOT MEANT TO BE USED ON YOUR ENTIRE DATA FRAME**

```{r}
ers_table(dataset = example_analysis_table, title = "XXX")
```

## Part 5: Upload File to Sharepoint

### 5.1 Set output data folder Path

**ACTION: Change the processed_data_folder_path to the path to your data. The folder path must start with a folder that is just below the "Client Work" level. For example, it should start with "District Partners", "Internal", "State Partners", etc..**

```{r}
processed_data_folder_path <- "District Partners/Yakima"
```

### 5.2 See guidance on using the "ers_write_sharepoint" function

**ACTION: Run the code below to see documentation on our custom function!**

```{r, eval = interactive()}
?ers_write_sharepoint
```

### 5.3 Write files

**ACTION: Replace "raw_data" with your desired name of your data and replace "XXX.csv" with the desired name of your output file. You can output CSV or XLSX files**

```{r}
#Example
ers_write_sharepoint(data = raw_data,
                     folder_path = processed_data_folder_path,
                     file_name_with_extension = "XXX.csv")
```

## Part 6: Knit the file into a nicely formatted HTML that you can share with teammates!

**ACTION: ALL YOU NEED TO DO IS Use Ctrl+Shift+K to knit your file, and it will upload an html file to your Github repo in a folder called "knitted files"!**

## OPTIONAL Part 7: Upload knitted file to Sharepoint

**ACTION: If you have made changes to your file since last knitting, make sure to knit first before running the code below. It will upload your knitted file to your "processed_data_folder_path" but you can change the destination_of_knitted_file below.**

```{r eval = FALSE}
# You can change the destination path of your knitted file here if you wish
destination_of_knitted_file <- processed_data_folder_path

# Define the path to the current R Markdown file
current_file <- rstudioapi::getActiveDocumentContext()$path

# Determine the output directory and file name for the knitted HTML
output_dir <- dirname(current_file)
output_file <- paste0(tools::file_path_sans_ext(basename(current_file)), ".html")
knitted_file <- file.path(output_dir, "knitted files", output_file)


client_work_drive <- orgfiles_site$get_drive("Client Work")

client_work_drive$upload_file(knitted_file, dest = file.path(destination_of_knitted_file, output_file))
```


