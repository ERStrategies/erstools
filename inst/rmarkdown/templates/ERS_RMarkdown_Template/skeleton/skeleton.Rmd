---
title: "1. Template Script"
author: "Zach Friedman"
date: "2024-07-19"
output:
  html_document:
    toc: true
    toc_depth: 3   # Customize the depth of the table of contents for HTML document
    toc_float:
      collapsed: true    # Start with the table of contents expanded
      smooth_scroll: true  # Enable smooth scrolling
  word_document:
    toc: true
    toc_depth: 3   # Customize the depth of the table of contents for Word document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_dir = "knitted files", output_format = "all") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Part 0: Read Libraries and connect to Sharepoint

### 0.0 START HERE: Save a GitHub token so that you can download our custom ERS Library! (ONLY NEED TO DO THIS ONCE)

1. Create a token in GitHub: Go to Github -> click on your profile in upper right -> Settings -> Scroll all the way down to "Developer Settings" -> Personal access tokens -> Tokens (classic) -> Generate new token -> Generate new token (classic) -> Choose custom expiration date (one year in the future) -> check only the "repo" box for scopes -> Copy the token)
2. Run the following in R to open the .Renviron file (this stores environment variables): usethis::edit_r_environ()
3. Add the following line to the file (replacing your_github_token with the token you copied from GitHub): GITHUB_PAT=your_github_token
4. Save the file and restart the R session. Now R will automatically use the token for GitHub authentication.


### 0.1 Load the devtools library

**ACTION: install the "devtools" package first if you don't have it**

```{r}
# install.packages("devtools")
library(devtools)
```

### 0.2 Install latest version of ERS Library!

**ACTION: A prompt might come up in your console below. Type 1 and press enter for All**

```{r}
devtools::install_github("ERStrategies/erstools", auth_token = Sys.getenv("GITHUB_PAT"))
```

### 0.3 Read Other Libraries

```{r, warning = F, message = F}
#ERS-specific functions!!
library(erstools) #includes functions like read_sharepoint_ers, write_sharepoint_ers, ers_table, and col_info
#load data
library(Microsoft365R) # Use Microsoft365R to connect to SharePoint and load files
library(readxl) # Functions for reading Excel files: read_excel
library(openxlsx) # Functions for writing Excel files: write.xlsx
library(rmarkdown) # needed to create knitted files in output folder

#manipulate data
library(tidyverse) # Includes ggplot2, dplyr, tidyr, readr, etc.
library(data.table) # fread(): load large CSVs quickly
library(janitor) # Functions for cleaning and examining data: clean_names() instantly formats all column names
library(safejoin) # Provides safer join operations for 1:many matching - safe_left_join()
library(stringr) # str_detect(): pattern matching using regular expressions (see regex101.com)
#format and display data
library(scales) # Functions for scaling and formatting axes in plots: comma(), percent()
library(gt) # Creates and formats tables in a publication-ready format: gt()
library(flextable) # Creates and formats tables in a publication-ready format: flextable()
library(extrafont) # Manages and uses custom fonts in plots - loadfonts(): Loads fonts available on the system

```

Part 1: Bring in your data

### 1.0 Authenticate to sharepoint to be able to read in files

**ACTION: Look at your console code window below for instructions to log in. A window will probably open in your browser to ask you to log into Microsoft to confirm your identity**

```{r}
#set sharepoint site URL for access to our org-wide and external files
orgfiles_site_url <- "https://erstrategies1.sharepoint.com/sites/orgfiles"
#access sharepoint site URL you may be prompted to sign in here
orgfiles_site <- get_sharepoint_site(site_url = orgfiles_site_url)
```

### 1.1 Set your folder path(s)

**ACTION: Change the raw_data_folder_path to the path to your data. The folder path must start with either "District Partners" or "Internal". See the comments below for guidance on how to find the path**

```{r}
raw_data_folder_path <- "District Partners/Columbus City/22-23 Financial Equity & Funding System Design/1. Data & Analysis - Secure/Raw Data for R"

# (Optional Guidance below) If you don't want to find the exact name of your folder path, you can copy it directly from Sharepoint: 
# 1. Navigate to the folder where your file exists in sharepoint 
# 2. click on the three dots (...) next to the folder
# 3. Click Details
# 4. Scroll all the way down past "activity" until you can copy the path by clicking the button next to "Path". If the list of activities is too long, then find a file within the folder and copy its path (then just remove the last part of the path with the name of the file)
# 5. Paste the Path in R
# 6. Use find and replace to replace instances of "%20" with spaces: " "
# 7. Remove the first part of the file path "https://erstrategies1.sharepoint.com/sites/orgfiles/Client Work" so that your path just starts with "District Partners" or "Internal". R already knows which sharepoint site to pull the folder from

```

### 1.2 See guidance on using the "read_sharepoint_ers" function 

**ACTION: Run the code below to see documentation on our custom function!**

```{r}
?read_sharepoint_ers
```

### 1.3 Read in your data

**ACTION: Replace "raw_data" with the desired name of your data frame and replace "XXX.csv" with the file name.**

```{r}

raw_data <- read_sharepoint_ers(folder_path = raw_data_folder_path,
                    file_name_with_extension = "XXX.csv")
```

### 1.4 View your data

**ACTION: Replace "raw_data" with the same name of your data frame you used above, and run the code to inspect your data.**

```{r}
View(raw_data)
```

## Part 2: Validate Data

### 2.0 Use ers_col_info function to validate data'


```{r}
#col_info function takes your data frame and outputs column information
#Example: ers_col_info(NCES_District_FY19)
ers_col_info <- function(data_name) 
  {data.frame(
    Column_Name = names(data_name),
    Data_Type = sapply(data_name, class),
    Count_Rows = sapply(data_name, function(x) length(na.omit(x))),
    NA_Rows = sapply(data_name, function(x) sum(is.na(x))),
    Missing_Rows = sapply(data_name, function(x) sum(x == "", na.rm = T)),
    Unique_Rows = sapply(data_name, function(x) length(unique(na.omit(x)))),
    stringsAsFactors = FALSE,
    row.names= NULL) 
  %>% flextable

  }

```

## Part Y: Upload File to Sharepoint

### Y.1 Set output data folder Path


**ACTION: Change the processed_data_folder_path to the path to your data. The folder path must start with either "District Partners" or "Internal". See the comments below for guidance on how to find the path**

```{r}
processed_data_folder_path <- "District Partners/Yakima/"
```


### Y.2 See guidance on using the "write_sharepoint_ers" function 

**ACTION: Run the code below to see documentation on our custom function!**

```{r}
?write_sharepoint_ers
```

### Y.3 Write files

**ACTION: Replace "raw_data" with your desired name of your data and replace "XXX.csv" with the desired name of your output file.**

```{r}
#Example
write_sharepoint_ers(data = DSI_test_data,
                     folder_path = processed_data_folder_path,
                     file_name_with_extension = "XXX.csv")
```

## Part Z: Knit the file

**ACTION: Use Ctrl+Shift+K to knit your file into a nicely formatted HTML/Word document that you can share with teammates!**

## Appendix: ERS Functions to Use

### 1. ers_table



```{r}
#turns your unpolished R tables into a table with nice formatting and a bolded table title
#Example: ers_table(dataset = NCES_District_FY19, title = "FY19 District Financials")
```

